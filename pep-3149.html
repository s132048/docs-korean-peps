<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">3149</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">ABI version tagged .so files</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-3149.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Barry Warsaw &lt;barry&#32;&#97;t&#32;python.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">2010-07-09</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.2</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">2010-07-14, 2010-07-22</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2010-September/103408.html">https://mail.python.org/pipermail/python-dev/2010-September/103408.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id21">Abstract</a></li>
<li><a class="reference internal" href="#background" id="id22">Background</a></li>
<li><a class="reference internal" href="#rationale" id="id23">Rationale</a></li>
<li><a class="reference internal" href="#proposal" id="id24">Proposal</a></li>
<li><a class="reference internal" href="#proven-approach" id="id25">Proven approach</a></li>
<li><a class="reference internal" href="#windows" id="id26">Windows</a></li>
<li><a class="reference internal" href="#pep-384" id="id27">PEP 384</a></li>
<li><a class="reference internal" href="#alternatives" id="id28">Alternatives</a><ul>
<li><a class="reference internal" href="#independent-directories-or-symlinks" id="id29">Independent directories or symlinks</a></li>
<li><a class="reference internal" href="#don-t-share-packages-with-extension-modules" id="id30">Don't share packages with extension modules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation" id="id31">Reference implementation</a></li>
<li><a class="reference internal" href="#references" id="id32">References</a></li>
<li><a class="reference internal" href="#copyright" id="id33">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id21">Abstract</a></h1>
<p><a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> <a class="footnote-reference" href="#id11" id="id1">[1]</a> described an extension to Python's import machinery that
improved the sharing of Python source code, by allowing more than one
byte compilation file (.pyc) to be co-located with each source file.</p>
<p>This PEP defines an adjunct feature which allows the co-location of
extension module files (.so) in a similar manner.  This optional,
build-time feature will enable downstream distributions of Python to
more easily provide more than one Python major version at a time.</p>
</div>
<div class="section" id="background">
<h1><a class="toc-backref" href="#id22">Background</a></h1>
<p><a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> defined the file system layout for a pure-Python package,
where multiple versions of Python are available on the system.  For
example, where the <cite>alpha</cite> package containing source modules <cite>one.py</cite>
and <cite>two.py</cite> exist on a system with Python 3.2 and 3.3, the post-byte
compilation file system layout would be:</p>
<pre class="literal-block">
alpha/
    __pycache__/
        __init__.cpython-32.pyc
        __init__.cpython-33.pyc
        one.cpython-32.pyc
        one.cpython-33.pyc
        two.cpython-32.pyc
        two.cpython-33.pyc
    __init__.py
    one.py
    two.py
</pre>
<p>For packages with extension modules, a similar differentiation is
needed for the module's .so files.  Extension modules compiled for
different Python major versions are incompatible with each other due
to changes in the ABI.  Different configuration/compilation options
for the same Python version can result in different ABIs
(e.g. --with-wide-unicode).</p>
<p>While <a class="reference external" href="/dev/peps/pep-0384">PEP 384</a> <a class="footnote-reference" href="#id12" id="id2">[2]</a> defines a stable ABI, it will minimize, but not
eliminate extension module incompatibilities between Python builds or
major versions.  Thus a mechanism for discriminating extension module
file names is proposed.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id23">Rationale</a></h1>
<p>Linux distributions such as Ubuntu <a class="footnote-reference" href="#id13" id="id3">[3]</a> and Debian <a class="footnote-reference" href="#id14" id="id4">[4]</a> provide more
than one Python version at the same time to their users.  For example,
Ubuntu 9.10 Karmic Koala users can install Python 2.5, 2.6, and 3.1,
with Python 2.6 being the default.</p>
<p>In order to share as much as possible between the available Python
versions, these distributions install third party package modules
(<tt class="docutils literal">.pyc</tt> and <tt class="docutils literal">.so</tt> files) into <cite>/usr/share/pyshared</cite> and symlink to
them from <cite>/usr/lib/pythonX.Y/dist-packages</cite>.  The symlinks exist
because in a pre-<a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> world (i.e &lt; Python 3.2), the <cite>.pyc</cite> files
resulting from byte compilation by the various installed Pythons will
name collide with each other.  For Python versions &gt;= 3.2, all
pure-Python packages can be shared, because the <cite>.pyc</cite> files will no
longer cause file system naming conflicts.  Eliminating these symlinks
makes for a simpler, more robust Python distribution.</p>
<p>A similar situation arises with shared library extensions.  Because
extension modules are typically named <cite>foo.so</cite> for a <cite>foo</cite> extension
module, these would also name collide if <cite>foo</cite> was provided for more
than one Python version.</p>
<p>In addition, because different configuration/compilation options for
the same Python version can cause different ABIs to be presented to
extension modules.  On POSIX systems for example, the configure
options <tt class="docutils literal"><span class="pre">--with-pydebug</span></tt>, <tt class="docutils literal"><span class="pre">--with-pymalloc</span></tt>, and
<tt class="docutils literal"><span class="pre">--with-wide-unicode</span></tt> all change the ABI.  This PEP proposes to
encode build-time options in the file name of the <tt class="docutils literal">.so</tt> extension
module files.</p>
<p>PyPy <a class="footnote-reference" href="#id15" id="id5">[5]</a> can also benefit from this PEP, allowing it to avoid name
collisions in extension modules built for its API, but with a
different <cite>.so</cite> tag.</p>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id24">Proposal</a></h1>
<p>The configure/compilation options chosen at Python interpreter
build-time will be encoded in the shared library file name for
extension modules.  This &quot;tag&quot; will appear between the module base
name and the operation file system extension for shared libraries.</p>
<p>The following information <em>MUST</em> be included in the shared library
file name:</p>
<ul class="simple">
<li>The Python implementation (e.g. cpython, pypy, jython, etc.)</li>
<li>The interpreter's major and minor version numbers</li>
</ul>
<p>These two fields are separated by a hyphen and no dots are to appear
between the major and minor version numbers.  E.g. <tt class="docutils literal"><span class="pre">cpython-32</span></tt>.</p>
<p>Python implementations <em>MAY</em> include additional flags in the file name
tag as appropriate.  For example, on POSIX systems these flags will
also contribute to the file name:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">--with-pydebug</span></tt> (flag: <tt class="docutils literal">d</tt>)</li>
<li><tt class="docutils literal"><span class="pre">--with-pymalloc</span></tt> (flag: <tt class="docutils literal">m</tt>)</li>
<li><tt class="docutils literal"><span class="pre">--with-wide-unicode</span></tt> (flag: <tt class="docutils literal">u</tt>)</li>
</ul>
<p>By default in Python 3.2, <tt class="docutils literal">configure</tt> enables <tt class="docutils literal"><span class="pre">--with-pymalloc</span></tt> so
shared library file names would appear as <tt class="docutils literal"><span class="pre">foo.cpython-32m.so</span></tt>.
When the other two flags are also enabled, the file names would be
<tt class="docutils literal"><span class="pre">foo.cpython-32dmu.so</span></tt>.</p>
<p>The shared library file name tag is used unconditionally; it cannot be
changed.  The tag and extension module suffix are available through
the <tt class="docutils literal">sysconfig</tt> modules via the following variables:</p>
<pre class="literal-block">
&gt;&gt;&gt; sysconfig.get_config_var('EXT_SUFFIX')
'.cpython-32mu.so'
&gt;&gt;&gt; sysconfig.get_config_var('SOABI')
'cpython-32mu'
</pre>
<p>Note that <tt class="docutils literal">$SOABI</tt> contains just the tag, while <tt class="docutils literal">$EXT_SUFFIX</tt> includes the
platform extension for shared library files, and is the exact suffix
added to the extension module name.</p>
<p>For an arbitrary package <cite>foo</cite>, you might see these files when the
distribution package was installed:</p>
<pre class="literal-block">
/usr/lib/python/foo.cpython-32m.so
/usr/lib/python/foo.cpython-33m.so
</pre>
<p>(These paths are for example purposes only.  Distributions are free to
use whatever filesystem layout they choose, and nothing in this PEP
changes the locations where from-source builds of Python are
installed.)</p>
<p>Python's dynamic module loader will recognize and import shared
library extension modules with a tag that matches its build-time
options.  For backward compatibility, Python will also continue to
import untagged extension modules, e.g. <tt class="docutils literal">foo.so</tt>.</p>
<p>This shared library tag would be used globally for all distutils-based
extension modules, regardless of where on the file system they are
built.  Extension modules built by means other than distutils would
either have to calculate the tag manually, or fallback to the
non-tagged <cite>.so</cite> file name.</p>
</div>
<div class="section" id="proven-approach">
<h1><a class="toc-backref" href="#id25">Proven approach</a></h1>
<p>The approach described here is already proven, in a sense, on Debian
and Ubuntu system where different extensions are used for debug builds
of Python and extension modules.  Debug builds on Windows also already
use a different file extension for dynamic libraries, and in fact
encoded (in a different way than proposed in this PEP) the Python
major and minor version in the <cite>.dll</cite> file name.</p>
</div>
<div class="section" id="windows">
<h1><a class="toc-backref" href="#id26">Windows</a></h1>
<p>This PEP only addresses build issues on POSIX systems that use the
<tt class="docutils literal">configure</tt> script.  While Windows or other platform support is not
explicitly disallowed under this PEP, platform expertise is needed in
order to evaluate, describe, and implement support on such platforms.
It is not currently clear that the facilities in this PEP are even
useful for Windows.</p>
</div>
<div class="section" id="pep-384">
<h1><a class="reference external" href="/dev/peps/pep-0384">PEP 384</a></h1>
<p><a class="reference external" href="/dev/peps/pep-0384">PEP 384</a> defines a stable ABI for extension modules.  In theory,
universal adoption of <a class="reference external" href="/dev/peps/pep-0384">PEP 384</a> would eliminate the need for this PEP
because all extension modules could be compatible with any Python
version.  In practice of course, it will be impossible to achieve
universal adoption, and as described above, different built-time flags
still affect the ABI.  Thus even with a stable ABI, this PEP may still
be necessary.  While a complete specification is reserved for <a class="reference external" href="/dev/peps/pep-0384">PEP 384</a>,
here is a discussion of the relevant issues.</p>
<p><a class="reference external" href="/dev/peps/pep-0384">PEP 384</a> describes a change to <tt class="docutils literal">PyModule_Create()</tt> where <tt class="docutils literal">3</tt> is
passed as the API version if the extension was complied with
<tt class="docutils literal">Py_LIMITED_API</tt>.  This should be formalized into an official macro
called <tt class="docutils literal">PYTHON_ABI_VERSION</tt> to mirror <tt class="docutils literal">PYTHON_API_VERSION</tt>.  If
and when the ABI changes in an incompatible way, this version number
would be bumped.  To facilitate sharing, Python would be extended to
search for extension modules with the <tt class="docutils literal">PYTHON_ABI_VERSION</tt> number in
its name.  The prefix <tt class="docutils literal">abi</tt> is reserved for Python's use.</p>
<p>Thus, an initial implementation of <a class="reference external" href="/dev/peps/pep-0384">PEP 384</a>, when Python is configured
with the default set of flags, would search for the following file
names when extension module <cite>foo</cite> is imported (in this order):</p>
<pre class="literal-block">
foo.cpython-XYm.so
foo.abi3.so
foo.so
</pre>
<p>The distutils <a class="footnote-reference" href="#id16" id="id6">[6]</a> <tt class="docutils literal">build_ext</tt> command would also have to be
extended to compile to shared library files with the <tt class="docutils literal">abi3</tt> tag,
when the module author indicates that their extension supports that
version of the ABI.  This could be done in a backward compatible way
by adding a keyword argument to the <tt class="docutils literal">Extension</tt> class, such as:</p>
<pre class="literal-block">
Extension('foo', ['foo.c'], abi=3)
</pre>
<p>Martin v. LÃ¶wis describes his thoughts <a class="footnote-reference" href="#id17" id="id7">[7]</a> about the applicability of this
PEP to <a class="reference external" href="/dev/peps/pep-0384">PEP 384</a>.  In summary:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">--with-pydebug</span></tt> would not be supported by the stable ABI because
this changes the layout of <tt class="docutils literal">PyObject</tt>, which is an exposed
structure.</li>
<li><tt class="docutils literal"><span class="pre">--with-pymalloc</span></tt> has no bearing on the issue.</li>
<li><tt class="docutils literal"><span class="pre">--with-wide-unicode</span></tt> is trickier, though Martin's inclination is
to force the stable ABI to use a <tt class="docutils literal">Py_UNICODE</tt> that matches the
platform's <tt class="docutils literal">wchar_t</tt>.</li>
</ul>
</div>
<div class="section" id="alternatives">
<h1><a class="toc-backref" href="#id28">Alternatives</a></h1>
<p>In the initial python-dev thread <a class="footnote-reference" href="#id18" id="id8">[8]</a> where this idea was first
introduced, several alternatives were suggested.  For completeness
they are listed here, along with the reasons for not adopting them.</p>
<div class="section" id="independent-directories-or-symlinks">
<h2><a class="toc-backref" href="#id29">Independent directories or symlinks</a></h2>
<p>Debian and Ubuntu could simply add a version-specific directory to
<tt class="docutils literal">sys.path</tt> that would contain just the extension modules for that
version of Python.  Or the symlink trick eliminated in <a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> could
be retained for just shared libraries.  This approach is rejected
because it propagates the essential complexity that <a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> tries to
avoid, and adds potentially several additional directories to search
for all modules, even when the number of extension modules is much
fewer than the total number of Python packages.  For example, builds
were made available both with and without wide unicode, with and
without pydebug, and with and without pymalloc, the total number of
directories search increases substantially.</p>
</div>
<div class="section" id="don-t-share-packages-with-extension-modules">
<h2><a class="toc-backref" href="#id30">Don't share packages with extension modules</a></h2>
<p>It has been suggested that Python packages with extension modules not
be shared among all supported Python versions on a distribution.  Even
with adoption of <a class="reference external" href="/dev/peps/pep-3149">PEP 3149</a>, extension modules will have to be compiled
for every supported Python version, so perhaps sharing of such
packages isn't useful anyway.  Not sharing packages with extensions
though is infeasible for several reasons.</p>
<p>If a pure-Python package is shared in one version, should it suddenly
be not-shared if the next release adds an extension module for speed?
Also, even though all extension shared libraries will be compiled and
distributed once for every supported Python, there's a big difference
between duplicating the <cite>.so</cite> files and duplicating all <cite>.py</cite> files.
The extra size increases the download time for such packages, and more
immediately, increases the space pressures on already constrained
distribution CD-ROMs.</p>
</div>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id31">Reference implementation</a></h1>
<p>Work on this code is tracked in a Bazaar branch on Launchpad <a class="footnote-reference" href="#id19" id="id9">[9]</a>
until it's ready for merge into Python 3.2.  The work-in-progress diff
can also be viewed <a class="footnote-reference" href="#id20" id="id10">[10]</a> and is updated automatically as new changes
are uploaded.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id32">References</a></h1>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="/dev/peps/pep-0384">PEP 384</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Ubuntu: &lt;<a class="reference external" href="http://www.ubuntu.com">http://www.ubuntu.com</a>&gt;</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Debian: &lt;<a class="reference external" href="http://www.debian.org">http://www.debian.org</a>&gt;</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="http://codespeak.net/pypy/dist/pypy/doc/">http://codespeak.net/pypy/dist/pypy/doc/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="http://docs.python.org/py3k/distutils/index.html">http://docs.python.org/py3k/distutils/index.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2010-August/103330.html">https://mail.python.org/pipermail/python-dev/2010-August/103330.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2010-June/100998.html">https://mail.python.org/pipermail/python-dev/2010-June/100998.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td><a class="reference external" href="https://code.edge.launchpad.net/~barry/python/sovers">https://code.edge.launchpad.net/~barry/python/sovers</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td><a class="reference external" href="https://code.edge.launchpad.net/~barry/python/sovers/+merge/29411">https://code.edge.launchpad.net/~barry/python/sovers/+merge/29411</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id33">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>

