<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">331</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Locale-Independent Float/String Conversions</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0331.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Christian R. Reis &lt;kiko at async.com.br&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">19-Jul-2003</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.4</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">21-Jul-2003, 13-Aug-2003, 18-Jun-2004</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id22">Abstract</a></li>
<li><a class="reference internal" href="#introduction" id="id23">Introduction</a></li>
<li><a class="reference internal" href="#rationale" id="id24">Rationale</a></li>
<li><a class="reference internal" href="#example-problem" id="id25">Example Problem</a></li>
<li><a class="reference internal" href="#proposal" id="id26">Proposal</a></li>
<li><a class="reference internal" href="#potential-code-contributions" id="id27">Potential Code Contributions</a></li>
<li><a class="reference internal" href="#risks" id="id28">Risks</a></li>
<li><a class="reference internal" href="#implementation" id="id29">Implementation</a></li>
<li><a class="reference internal" href="#references" id="id30">References</a></li>
<li><a class="reference internal" href="#copyright" id="id31">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id22">Abstract</a></h1>
<p>Support for the <tt class="docutils literal">LC_NUMERIC</tt> locale category in Python 2.3 is
implemented only in Python-space.  This causes inconsistent
behavior and thread-safety issues for applications that use
extension modules and libraries implemented in C that parse and
generate floats from strings.  This document proposes a plan for
removing this inconsistency by providing and using substitute
locale-agnostic functions as necessary.</p>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id23">Introduction</a></h1>
<p>Python provides generic localization services through the locale
module, which among other things allows localizing the display and
conversion process of numeric types.  Locale categories, such as
<tt class="docutils literal">LC_TIME</tt> and <tt class="docutils literal">LC_COLLATE</tt>, allow configuring precisely what aspects
of the application are to be localized.</p>
<p>The <tt class="docutils literal">LC_NUMERIC</tt> category specifies formatting for non-monetary
numeric information, such as the decimal separator in float and
fixed-precision numbers.  Localization of the <tt class="docutils literal">LC_NUMERIC</tt> category
is currently implemented only in Python-space; C libraries invoked
from the Python runtime are unaware of Python's <tt class="docutils literal">LC_NUMERIC</tt>
setting.  This is done to avoid changing the behavior of certain
low-level functions that are used by the Python parser and related
code <a class="footnote-reference" href="#id12" id="id1">[2]</a>.</p>
<p>However, this presents a problem for extension modules that wrap C
libraries.  Applications that use these extension modules will
inconsistently display and convert floating-point values.</p>
<p>James Henstridge, the author of PyGTK <a class="footnote-reference" href="#id13" id="id2">[3]</a>, has additionally
pointed out that the <tt class="docutils literal">setlocale()</tt> function also presents
thread-safety issues, since a thread may call the C library
<tt class="docutils literal">setlocale()</tt> outside of the GIL, and cause Python to parse and
generate floats incorrectly.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id24">Rationale</a></h1>
<p>The inconsistency between Python and C library localization for
<tt class="docutils literal">LC_NUMERIC</tt> is a problem for any localized application using C
extensions.  The exact nature of the problem will vary depending
on the application, but it will most likely occur when parsing or
formatting a floating-point value.</p>
</div>
<div class="section" id="example-problem">
<h1><a class="toc-backref" href="#id25">Example Problem</a></h1>
<p>The initial problem that motivated this PEP is related to the
GtkSpinButton <a class="footnote-reference" href="#id14" id="id3">[4]</a> widget in the GTK+ UI toolkit, wrapped by the
PyGTK module.  The widget can be set to numeric mode, and when
this occurs, characters typed into it are evaluated as a number.</p>
<p>Problems occur when <tt class="docutils literal">LC_NUMERIC</tt> is set to a locale with a float
separator that differs from the C locale's standard (for instance,
',' instead of '.' for the Brazilian locale pt_BR).  Because
<tt class="docutils literal">LC_NUMERIC</tt> is not set at the libc level, float values are
displayed incorrectly (using '.' as a separator) in the
spinbutton's text entry, and it is impossible to enter fractional
values using the ',' separator.</p>
<p>This small example demonstrates reduced usability for localized
applications using this toolkit when coded in Python.</p>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id26">Proposal</a></h1>
<p>Martin v. Löwis commented on the initial constraints for an
acceptable solution to the problem on python-dev:</p>
<ul class="simple">
<li><tt class="docutils literal">LC_NUMERIC</tt> can be set at the C library level without
breaking the parser.</li>
<li><tt class="docutils literal">float()</tt> and <tt class="docutils literal">str()</tt> stay locale-unaware.</li>
<li>locale-aware <tt class="docutils literal">str()</tt> and <tt class="docutils literal">atof()</tt> stay in the locale module.</li>
</ul>
<p>An analysis of the Python source suggests that the following
functions currently depend on <tt class="docutils literal">LC_NUMERIC</tt> being set to the C
locale:</p>
<ul class="simple">
<li><tt class="docutils literal">Python/compile.c:parsenumber()</tt></li>
<li><tt class="docutils literal">Python/marshal.c:r_object()</tt></li>
<li><tt class="docutils literal">Objects/complexobject.c:complex_to_buf()</tt></li>
<li><tt class="docutils literal">Objects/complexobject.c:complex_subtype_from_string()</tt></li>
<li><tt class="docutils literal">Objects/floatobject.c:PyFloat_FromString()</tt></li>
<li><tt class="docutils literal">Objects/floatobject.c:format_float()</tt></li>
<li><tt class="docutils literal">Objects/stringobject.c:formatfloat()</tt></li>
<li><tt class="docutils literal">Modules/stropmodule.c:strop_atof()</tt></li>
<li><tt class="docutils literal">Modules/cPickle.c:load_float()</tt></li>
</ul>
<p>The proposed approach is to implement <tt class="docutils literal">LC_NUMERIC</tt>-agnostic
functions for converting from (<tt class="docutils literal">strtod()</tt>/<tt class="docutils literal">atof()</tt>) and to
(<tt class="docutils literal">snprintf()</tt>) float formats, using these functions where the
formatting should not vary according to the user-specified locale.</p>
<p>The locale module should also be changed to remove the
special-casing for <tt class="docutils literal">LC_NUMERIC</tt>.</p>
<p>This change should also solve the aforementioned thread-safety
problems.</p>
</div>
<div class="section" id="potential-code-contributions">
<h1><a class="toc-backref" href="#id27">Potential Code Contributions</a></h1>
<p>This problem was initially reported as a problem in the GTK+
libraries <a class="footnote-reference" href="#id15" id="id4">[5]</a>; since then it has been correctly diagnosed as an
inconsistency in Python's implementation.  However, in a fortunate
coincidence, the glib library (developed primarily for GTK+, not
to be confused with the GNU C library) implements a number of
<tt class="docutils literal">LC_NUMERIC</tt>-agnostic functions (for an example, see <a class="footnote-reference" href="#id16" id="id5">[6]</a>) for
reasons similar to those presented in this paper.</p>
<p>In the same GTK+ problem report, Havoc Pennington suggested that
the glib authors would be willing to contribute this code to the
PSF, which would simplify implementation of this PEP considerably.
Alex Larsson, the original author of the glib code, submitted a
PSF Contributor Agreement <a class="footnote-reference" href="#id17" id="id6">[7]</a> on 2003-08-20 <a class="footnote-reference" href="#id18" id="id7">[8]</a> to ensure the code
could be safely integrated; this agreement has been received and
accepted.</p>
</div>
<div class="section" id="risks">
<h1><a class="toc-backref" href="#id28">Risks</a></h1>
<p>There may be cross-platform issues with the provided
locale-agnostic functions, though this risk is low given that the
code supplied simply reverses any locale-dependent changes made to
floating-point numbers.</p>
<p>Martin and Guido pointed out potential copyright issues with the
contributed code.  I believe we will have no problems in this area
as members of the GTK+ and glib teams have said they are fine with
relicensing the code, and a PSF contributor agreement has been
mailed in to ensure this safety.</p>
<p>Tim Peters has pointed out <a class="footnote-reference" href="#id19" id="id8">[9]</a> that there are situations involving
threading in which the proposed change is insufficient to solve
the problem completely.  A complete solution, however, does not
currently exist.</p>
</div>
<div class="section" id="implementation">
<h1><a class="toc-backref" href="#id29">Implementation</a></h1>
<p>An implementation was developed by Gustavo Carneiro &lt;gjc at
inescporto.pt&gt;, and attached to Sourceforge.net bug 774665 <a class="footnote-reference" href="#id20" id="id9">[10]</a></p>
<p>The final patch <a class="footnote-reference" href="#id21" id="id10">[11]</a> was integrated into Python CVS by Martin v.
Löwis on 2004-06-08, as stated in the bug report.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id30">References</a></h1>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="/dev/peps/pep-0001">PEP 1</a>, PEP Purpose and Guidelines, Warsaw, Hylton
<a class="reference external" href="http://www.python.org/dev/peps/pep-0001/">http://www.python.org/dev/peps/pep-0001/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td>Python locale documentation for embedding,
<a class="reference external" href="http://docs.python.org/library/locale.html">http://docs.python.org/library/locale.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[3]</a></td><td>PyGTK homepage, <a class="reference external" href="http://www.daa.com.au/~james/pygtk/">http://www.daa.com.au/~james/pygtk/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[4]</a></td><td>GtkSpinButton screenshot (demonstrating problem),
<a class="reference external" href="http://www.async.com.br/~kiko/spin.png">http://www.async.com.br/~kiko/spin.png</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[5]</a></td><td>GNOME bug report, <a class="reference external" href="http://bugzilla.gnome.org/show_bug.cgi?id=114132">http://bugzilla.gnome.org/show_bug.cgi?id=114132</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[6]</a></td><td>Code submission of g_ascii_strtod and g_ascii_dtostr (later
renamed g_ascii_formatd) by Alex Larsson,
<a class="reference external" href="http://mail.gnome.org/archives/gtk-devel-list/2001-October/msg00114.html">http://mail.gnome.org/archives/gtk-devel-list/2001-October/msg00114.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[7]</a></td><td>PSF Contributor Agreement,
<a class="reference external" href="https://www.python.org/psf/contrib/contrib-form/">https://www.python.org/psf/contrib/contrib-form/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[8]</a></td><td>Alex Larsson's email confirming his agreement was mailed in,
<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2003-August/037755.html">https://mail.python.org/pipermail/python-dev/2003-August/037755.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[9]</a></td><td>Tim Peters' email summarizing LC_NUMERIC trouble with Spambayes,
<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2003-September/037898.html">https://mail.python.org/pipermail/python-dev/2003-September/037898.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[10]</a></td><td>Python bug report, <a class="reference external" href="https://bugs.python.org/issue774665">https://bugs.python.org/issue774665</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id21" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[11]</a></td><td>Integrated LC_NUMERIC-agnostic patch,
<a class="reference external" href="https://sourceforge.net/tracker/download.php?group_id=5470&amp;atid=305470&amp;file_id=89685&amp;aid=774665">https://sourceforge.net/tracker/download.php?group_id=5470&amp;atid=305470&amp;file_id=89685&amp;aid=774665</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id31">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>

